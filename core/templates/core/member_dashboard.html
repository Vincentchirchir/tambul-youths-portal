{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tambul Member Dashboard</title>
    <link rel="icon" type="image/svg+xml" sizes="any" href="{% static 'images/favicon.svg' %}" />
    <link rel="alternate icon" type="image/png" href="{% static 'images/logo.png' %}" />
    <link rel="stylesheet" href="{% static 'core/member_dashboard.css' %}" />
  </head>
  <body>
    <!-- ===== HEADER ===== -->
    <header class="topbar">
      <div class="brand">
        <img
          src="{% static 'images/logo.png' %}"
          alt="Tambul logo"
          class="brand-logo"
        />
        <div class="brand-copy">
          <h2>Tambul Hustle Youth Group</h2>
          <span class="sub">Member Dashboard</span>
        </div>
      </div>

      <div class="topbar-center">
        <span class="topbar-greeting">Welcome, {{ request.user.first_name }}</span>
      </div>

      <div class="topbar-right">
        <div class="notif-container">
          <button id="notif-btn" class="notif-btn">
            ðŸ””
            <span id="notif-count" class="notif-count">
              {% if unread_notifications %}{{ unread_notifications }}{% endif %}
            </span>
          </button>
          <div id="notif-panel" class="notif-panel hidden">
            <div id="notif-list"></div>
            <button id="load-more" class="load-more" hidden>Load More</button>
          </div>
        </div>
        <span class="year">{{ this_year }}</span>
        <div class="profile-dropdown">
          <button class="profile-toggle">
            <span class="profile-icon">
              {{ request.user.first_name|slice:":1" }}{{ request.user.last_name|slice:":1" }}
            </span>
            <span class="profile-name">{{ request.user.first_name }}</span>
            <span class="caret">â–¾</span>
          </button>
          <div class="profile-menu hidden">
            <a href="{% url 'profile' %}">My Profile</a>
            <form action="{% url 'logout' %}" method="post">
              {% csrf_token %}
              <button type="submit">Logout</button>
            </form>
          </div>
        </div>
      </div>
    </header>

    {% include "core/partials/messages.html" %}

    <!-- ===== MAIN CONTENT ===== -->
    <main class="dashboard">
      <div class="welcome">
        <h2>Welcome, {{ request.user.first_name }}</h2>
        <div class="loan-cta">
          {% if can_apply_loan %}
            <a href="{% url 'apply-loan' %}" class="btn btn-primary"> Apply for Loan</a>
          {% else %}
            <span class="loan-note">
              You currently have an active or unpaid loan. Clear it before applying again.
            </span>
          {% endif %}
        </div>
      </div>

      <!-- KPIs -->
      <section class="overview">
        <div class="card">
          <h4>Ksh {{ contrib_ytd|floatformat:2 }}</h4>
          <p> My Total Contributions</p>
        </div>
        <div class="card">
          <h4>{{ active_loan_count }}</h4>
          <p>My Active Loans</p>
        </div>
        <div class="card">
          <h4>Ksh {{ outstanding_principal|floatformat:2 }}</h4>
          <p>Total Loan Borrowed</p>
        </div>
        <div class="card">
          <h4>Ksh {{ loan_balance|floatformat:2 }}</h4>
          <p>Total Loan Balance</p>
        </div>
      </section>

      <!-- Announcements -->
        <section class="table-section">
          <h3 class="section-title">Latest Announcements</h3>
          <div class="table-wrap">
            <table class="styled-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Message</th>
                  <th>Date</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for a in latest_announcements %}
                <tr>
                  <td>{{ forloop.counter }}</td>
                  <td>{{ a.title }}</td>
                  <td>{{ a.message|truncatewords:12 }}</td>
                  <td>{{ a.published_at|date:"M d, Y" }}</td>
                  <td>
                    <button
                      type="button"
                      class="btn btn-outline-info btn-sm"
                      onclick="openAnnouncementModal('{{ a.id }}')"
                    >
                      <i class="fa fa-eye"></i> View
                    </button>

                    <!-- Hidden modal content -->
                    <div id="announcement-content-{{ a.id }}" style="display:none;">
                      <h4>{{ a.title }}</h4>
                      <p>{{ a.message|linebreaks }}</p>
                      <p><strong>Date Posted:</strong> {{ a.published_at|date:"F d, Y" }}</p>
                    </div>
                  </td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="5" class="empty">No announcements yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </section>

        <!-- Modal -->
        <div id="announcementModal" class="modal">
          <div class="modal-content">
            <span class="close" onclick="closeAnnouncementModal()">&times;</span>
            <div id="announcement-body"></div>
          </div>
        </div>


      <!-- Loans -->

      <section class="table-section">
        <h3 class="section-title">My Loans</h3>
        <div class="table-wrap">
          <table class="styled-table">
            <thead>
              <tr>
                <th>Loan Date</th>
                <th>Due Date</th>
                <th>Today</th>
                <th>Amount (Ksh)</th>
                <th>Interest (10%)</th>
                <th>Approval Status</th>
                <th>Repayment Status</th>
                <th>Months Overdue</th>
                <th>Penalty</th>
                <th>Total (Ksh)</th>
                <th>Updated On</th>
              </tr>
            </thead>
            <tbody>
              {% for loan in loans %}
              <tr>
                <td>{{ loan.loan_date|date:"M d, Y" }}</td>
                <td>{{ loan.due_date|date:"M d, Y" }}</td>
                <td>{{ today|date:"M d, Y" }}</td>
                <td>{{ loan.amount|floatformat:0 }}</td>
                <td>{{ loan.interest|floatformat:0 }}</td>

                <!-- Approval Status -->
                <td>
                  <span class="status status--{{ loan.status|slugify }}">
                    {{ loan.status|capfirst }}
                  </span>
                </td>

                <!-- Repayment Status -->
                <td>
                  <span class="status status--{{ loan.repayment_status|slugify }}">
                    {{ loan.repayment_status|capfirst }}
                  </span>
                </td>

                <!-- Months Overdue -->
                <td>{{ loan.months_overdue }}</td>

                <!-- Penalty -->
                <td>{{ loan.penalty|floatformat:0 }}</td>

                <!-- Total -->
                <td>{{ loan.total_balance|floatformat:0 }}</td>

                <!-- Last Updated -->
                <td>{{ loan.repayment_updated_at|date:"M d, Y"|default:"â€”" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="11" class="empty">No loan records found</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Monthly Contributions -->
      <section class="table-section">
        <h3 class="section-title">My Monthly Contributions</h3>
        <div class="table-wrap">
          <table class="styled-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Month</th>
                <th>Amount (Ksh)</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for c in recent_contributions %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ c.month|date:"F Y" }}</td>
                <td>{{ c.amount|floatformat:2 }}</td>
                <td>{{ c.created_at|date:"M d, Y" }}</td>
                <td>
                  <span class="status status--{{ c.status|slugify }}">
                    {{ c.get_status_display }}
                  </span>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="empty">No contributions yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Welfare -->
      <section class="table-section">
        <h3 class="section-title">My Welfare Contributions</h3>
        <div class="table-wrap">
          <table class="styled-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Month</th>
                <th>Amount (Ksh)</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for w in recent_welfare %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ w.date_given|date:"F Y" }}</td>
                <td>{{ w.amount|floatformat:2 }}</td>
                <td>
                  <span class="status status--{{ w.status|slugify }}">
                    {{ w.status|capfirst }}
                  </span>
                </td>
                <td>{{ w.date_given|date:"M d, Y" }}</td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="empty">No contributions yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Reports (Meeting Minutes) -->
      <section class="table-section">
        <h3 class="section-title">Reports & Meeting Minutes</h3>
        <div class="table-wrap">
          <table class="styled-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Title</th>
                <th>Description</th>
                <th>Date Posted</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              {% for note in meeting_notes %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ note.title }}</td>
                <td>
                  <span class="note-description" title="{{ note.description }}">
                    {{ note.description|default:"â€”" }}
                  </span>
                </td>
                <td>{{ note.created_at|date:"M d, Y" }}</td>
                <td>
                  {% if note.file %}
                    <a href="{{ note.file.url }}" target="_blank" class="btn btn-primary btn-sm">
                      Download
                    </a>
                  {% elif note.content %}
                    <button type="button" class="btn btn-outline-info btn-sm"
                      onclick="openMinutesModal('{{ note.id }}')">
                      View Notes
                    </button>

                    <!-- Hidden modal content -->
                    <div id="minutes-content-{{ note.id }}" style="display:none;">
                      <h4>{{ note.title }}</h4>
                      <p>{{ note.content|linebreaks }}</p>
                    </div>
                  {% else %}
                    <span class="muted">No file or text</span>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="5" class="empty">No meeting minutes yet</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <!-- Modal -->
      <div id="minutesModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeMinutesModal()">&times;</span>
          <div id="modal-body"></div>
        </div>
      </div>

    </main>

    <script>
      function openAnnouncementModal(id) {
        const modal = document.getElementById("announcementModal");
        const body = document.getElementById("announcement-body");
        const content = document.getElementById(`announcement-content-${id}`).innerHTML;
        body.innerHTML = content;
        modal.style.display = "block";
      }

      function closeAnnouncementModal() {
        const modal = document.getElementById("announcementModal");
        modal.style.display = "none";
      }

      function openMinutesModal(noteId) {
        const modal = document.getElementById("minutesModal");
        const content = document.getElementById(`minutes-content-${noteId}`);
        const modalBody = document.getElementById("modal-body");

        modalBody.innerHTML = content.innerHTML;
        modal.style.display = "flex";
      }

      function closeMinutesModal() {
        const modal = document.getElementById("minutesModal");
        modal.style.display = "none";
      }

      window.addEventListener("click", (event) => {
        const announcementModal = document.getElementById("announcementModal");
        const minutesModal = document.getElementById("minutesModal");

        if (event.target === announcementModal) {
          announcementModal.style.display = "none";
        }

        if (event.target === minutesModal) {
          minutesModal.style.display = "none";
        }
      });
    </script>

    <script>
      const chartData = JSON.parse("{{ chart_datasets_json|escapejs }}");
      const {
        monthlyLabels = [],
        monthlyValues = [],
        loanLabels = [],
        loanCounts = [],
        welfareLabels = [],
        welfareTotals = [],
        topContributors = [],
        topContribValues = [],
      } = chartData;

      new Chart(document.getElementById("contribChart"), {
        type: "line",
        data: {
          labels: monthlyLabels,
          datasets: [
            {
              label: "Contributions (Ksh)",
              data: monthlyValues,
              borderColor: "#00bfa5",
              backgroundColor: "rgba(0,191,165,0.15)",
              tension: 0.4,
              fill: true,
            },
          ],
        },
        options: { responsive: true, plugins: { legend: { display: false } } },
      });

      new Chart(document.getElementById("loanChart"), {
        type: "doughnut",
        data: {
          labels: loanLabels,
          datasets: [
            {
              data: loanCounts,
              backgroundColor: ["#00bfa5", "#ffb300", "#e53935"],
            },
          ],
        },
        options: { responsive: true },
      });

      new Chart(document.getElementById("welfareChart"), {
        type: "bar",
        data: {
          labels: welfareLabels,
          datasets: [
            {
              label: "Welfare (Ksh)",
              data: welfareTotals,
              backgroundColor: ["#00bfa5", "#e53935", "#ffb300"],
            },
          ],
        },
        options: {
          responsive: true,
          indexAxis: "y",
          plugins: { legend: { display: false } },
        },
      });

      new Chart(document.getElementById("topContribChart"), {
        type: "bar",
        data: {
          labels: topContributors,
          datasets: [
            {
              label: "Total (Ksh)",
              data: topContribValues,
              backgroundColor: "#003b46",
            },
          ],
        },
        options: { responsive: true, plugins: { legend: { display: false } } },
      });
    </script>

<script>
  const bell = document.getElementById("notif-btn");
  const panel = document.getElementById("notif-panel");
  const notifList = document.getElementById("notif-list");
  const badge = document.getElementById("notif-count");
  const loadMoreBtn = document.getElementById("load-more");
  const profileToggle = document.querySelector(".profile-toggle");
  const profileMenu = document.querySelector(".profile-menu");
  let nextPage = 1;

  const openNotifPanel = () => {
    if (!panel) return;
    panel.classList.remove("hidden");
    panel.classList.remove("is-closing");
    requestAnimationFrame(() => panel.classList.add("active"));
  };

  const closeNotifPanel = () => {
    if (!panel) return;
    if (!panel.classList.contains("active")) {
      panel.classList.add("hidden");
      panel.classList.remove("is-closing");
      return;
    }

    function finalize() {
      panel.removeEventListener("transitionend", handleTransitionEnd);
      if (!panel.classList.contains("active")) {
        panel.classList.add("hidden");
        panel.classList.remove("is-closing");
      }
    }

    function handleTransitionEnd(event) {
      if (event.target !== panel) return;
      finalize();
    }

    panel.classList.add("is-closing");
    panel.addEventListener("transitionend", handleTransitionEnd);
    panel.classList.remove("active");
    window.setTimeout(finalize, 280);
  };

  // --- Update badge ---
  const updateBadge = (count) => {
    if (!badge) return;
    if (count > 0) {
      badge.textContent = count;
      badge.style.display = "inline-block";
      bell.classList.add("has-unread");
    } else {
      badge.textContent = "";
      badge.style.display = "none";
      bell.classList.remove("has-unread");
    }
  };

  // --- Load notifications ---
  function loadNotifications(reset = false) {
    const url = new URL("{% url 'notification_fetch' %}", window.location.origin);
    url.searchParams.set("page", nextPage || 1);

    fetch(url)
      .then((res) => res.json())
      .then((data) => {
        if (reset) notifList.innerHTML = "";

        if (!data.notifications || data.notifications.length === 0) {
          notifList.innerHTML = `<div class="notif-empty">No notifications yet</div>`;
          loadMoreBtn.hidden = true;
        } else {
          data.notifications.forEach((n) => {
            const item = document.createElement("a");
            item.href = n.link || "#";
            item.target = "_blank";
            item.className = "notif-item" + (n.is_read ? " notif-item--read" : "");
            item.dataset.id = n.id;
            item.innerHTML = `
              <p class="notif-title">${n.title}</p>
              <p class="notif-msg">${n.message}</p>
              <small>${n.created_at}</small>
            `;
            notifList.appendChild(item);
          });

          if (data.has_next) {
            nextPage = data.next_page;
            loadMoreBtn.hidden = false;
          } else {
            nextPage = null;
            loadMoreBtn.hidden = true;
          }
        }

        updateBadge(data.unread_count || 0);
      })
      .catch(() => {
        notifList.innerHTML = `<div class="notif-empty">Unable to load notifications</div>`;
      });
  }

  // --- Click: toggle notification panel ---
  bell.addEventListener("click", (event) => {
    event.stopPropagation();
    const isOpen = panel.classList.contains("active");
    const isClosing = panel.classList.contains("is-closing");
    const shouldOpen = !isOpen || isClosing;

    if (profileMenu && !profileMenu.classList.contains("hidden")) {
      profileMenu.classList.add("hidden");
    }

    if (shouldOpen) {
      openNotifPanel();
      nextPage = 1;
      loadNotifications(true);
    } else {
      closeNotifPanel();
    }
  });

  // --- Load more ---
  loadMoreBtn.addEventListener("click", () => {
    if (nextPage) loadNotifications(false);
  });

  // --- Click: mark read & open link ---
  notifList.addEventListener("click", (event) => {
    const item = event.target.closest(".notif-item");
    if (!item) return;

    const id = item.dataset.id;
    const link = item.getAttribute("href");

    item.classList.add("notif-item--read");
    const current = parseInt((badge && badge.textContent) || "0", 10) || 0;
    updateBadge(Math.max(current - 1, 0));

    if (id) fetch(`/notifications/read/${id}/`);
    if (link && link !== "#") window.open(link, "_blank");

    closeNotifPanel();
  });

  // --- WebSocket live updates ---
  const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${wsProtocol}://${window.location.host}/ws/notifications/`);
  socket.onmessage = () => {
    const current = parseInt((badge && badge.textContent) || "0", 10) || 0;
    updateBadge(current + 1);
    nextPage = 1;
    loadNotifications(true);
  };

  // --- Profile dropdown ---
  if (profileToggle && profileMenu) {
    profileToggle.addEventListener("click", (e) => {
      e.stopPropagation();
      profileMenu.classList.toggle("hidden");

      if (!panel.classList.contains("hidden")) {
        closeNotifPanel();
      }
    });
  }

  // --- Close everything when clicking outside ---
  document.addEventListener("click", (event) => {
    if (
      !bell.contains(event.target) &&
      !panel.contains(event.target) &&
      (!profileToggle || !profileToggle.contains(event.target)) &&
      (!profileMenu || !profileMenu.contains(event.target))
    ) {
      closeNotifPanel();
      if (profileMenu) profileMenu.classList.add("hidden");
    }
  });

  // --- Auto load and auto refresh ---
  loadNotifications(true);
  setInterval(() => loadNotifications(true), 60000);
</script>


    <!-- ===== FOOTER ===== -->
    <footer class="footer">
      <p>&copy; {{ this_year }} Tambul Hustle Youth Group. All rights reserved.</p>
    </footer>
  </body>
</html>
